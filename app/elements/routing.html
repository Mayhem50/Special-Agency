<script src="../../bower_components/page/page.js"></script>
<script>
    window.addEventListener('WebComponentsReady', function () {
        page('/', function () {
            isAuthenticated('home');
        });

        page('/login', function () {
            app.route = 'login';
        });

        page('/logout', function () {
            $.ajax({
                url: 'http://127.0.0.1:3000/logout',
                statusCode : {
                    200 : function(){
                        app.route = 'login';
                        clearToken();
                        document.querySelector('#deconnexionToggle').hide();
                    }
                },
                type: 'POST'
            });
        });

        page('/profile/:name', function (data) {
            isAuthenticated('profile');
            app.params = data.params;
        });

        page('/users', function () {
            app.route = 'users';
        });

        page('/users/:name', function (data) {
            app.route = 'user-info';
            app.params = data.params;
        });

        page('/missions', function () {
            isAuthenticated('missions');
        })

        // add #! before urls
        page({
            hashbang: true
        });        

        function clearToken() {
            if (window.localStorage['remember'] == "true") {
                window.localStorage.token = '';
            }
            else {
                window.sessionStorage.token = '';
            }
        }
    });

    function isAuthenticated(route) {
        $.ajax({
            url: 'http://127.0.0.1:3000/token',
            statusCode : {
                200 : function(){
                    app.route = route;
                },
                403 : function(){
                    app.route = 'login';
                }
            },
            type : 'POST'
        });
    }

    window.addEventListener('load', function (event) {
        if (window.localStorage['remember'] == "true") {
            window.sessionStorage.token = window.localStorage.token;
            document.querySelector('#deconnexionToggle').show();
            $.ajaxSetup({
                headers: {
                    'x-access-token': window.sessionStorage.token
                }
            });
        }

        $.ajax({
            url: 'http://127.0.0.1:3000/token',
            statusCode: {
                200: function () {
                    app.route = 'home';
                    app.isLogged = '/profile/' + window.localStorage['email'];
                },
                403: function () {
                    app.route = 'login';
                    app.isLogged = app.route;
                }
            },
            type: 'POST'
        });
    });

    window.addEventListener('unload', function (event) {
        if (window.localStorage['remember'] != "true") {
            window.localStorage.token = '';
        }
    });
</script>
