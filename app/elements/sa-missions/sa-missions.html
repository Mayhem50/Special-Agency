<link rel="import" href="sa-mission-consult.html" />
<link rel="import" href="sa-mission-create.html" />
<link rel="import" href="sa-mission-edit.html" />
<link rel="import" href="sa-missions-list.html" />
<link rel="import" href="../sa-kinds/sa-kinds-list.html" />
<link rel="import" href="../sa-toolbar/sa-secondary-toolbar-main.html" />
<link rel="import" href="../sa-toolbar/sa-secondary-toolbar-second.html" />
<link rel="import" href="../sa-toolbar/sa-toolbar-filter.html" />

<dom-module id="sa-missions">
    <style>
        :host {
            height: 100%;
            --paper-input-container-label : {                    
                    color: #cccccc;
            }
            --paper-input-container-input-color: #cccccc;
            --paper-input-container-underline-focus: {
                background: rgba(20, 20, 20, 0.97);
            }
            --paper-menu-button-dropdown-background:rgba(0, 0, 0, 0.67);
            --paper-dropdown-menu-input:{
                rgba(0, 0, 0, 0.67);
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            background-color:#555452;
        }
    </style>
    <template>
        <div class="container">
            <iron-pages id="toolbar" selected="0">
                <sa-secondary-toolbar-main filter="{{_mainFilter}}"></sa-secondary-toolbar-main>
                <sa-secondary-toolbar-second kind="[[_selectedKind]]" on-back-to-previous-page="_backToPreviousPage" create-mission="[[createMission]]"></sa-secondary-toolbar-second>
            </iron-pages>
            <iron-collapse id="filter-toolbar">
                <sa-toolbar-filter on-sort-changed="_onSortedChanged"
                                   kind="[[_selectedKind]]"
                                   on-filter-add="_onFilterAdd"
                                   on-filter-remove="_onFilterRemove"></sa-toolbar-filter>
            </iron-collapse>
            <iron-pages id="pages" attr-for-selected="data-page" selected="missions">                

                <section data-page="missions">
                    <sa-missions-list filter="[[_missionsFilter]]" sort="[[_missionsSort]]"></sa-missions-list>
                </section>
                <section data-page="kinds">
                    <sa-kinds-list on-show-missions="_onShowMissionsOfKind" on-get-kinds="_onGetKinds"></sa-kinds-list>
                </section>
                <section data-page="consultation">
                    <sa-mission-consult mission="[[mission]]"
                                      kind="[[_selectedKind]]"
                                      on-offer-service="_onOfferService"
                                      on-close-infos="_onCloseInfos"
                                      on-cancel="_onCancel">
                    </sa-mission-consult>
                </section>
                <section data-page="creation">
                    <sa-mission-create mission="{{mission}}"
                                       kind="{{_selectedKind}}"
                                       kinds="[[_kinds]]"
                                       on-create-mission="_onCreateMission"
                                       on-cancel="_onCancel"
                                       update="[[_missionCreateUpdate]]"
                                       >
                    </sa-mission-create>
                </section>
                <section data-page="edition">
                    <sa-mission-edit mission="{{mission}}"
                                     kind="[[_selectedKind]]"
                                     on-update-mission="_onUpdateMission"
                                     on-cancel="_onCancel">
                    </sa-mission-edit>
                </section>
            </iron-pages>
        </div>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-missions',

                properties: {
                    _kinds: Object,
                    _mainFilter: {
                        type: String,
                        observer: '_mainFilterChange'
                    },
                    _missionCreateUpdate: {
                        type: Boolean,
                        value: false
                    },
                    _missionsListUpdate: {
                        type: Boolean,
                        value: false
                    },
                    _kindsListUpdate: {
                        type: Boolean,
                        value: false
                    },
                    _missionsFilter: {
                        type:Object
                    },
                    createMission: {
                        type: Boolean,
                        notify: true,
                        observer: '_onBeginCreation'
                    },
                    _fromPages: {
                        type: Array,
                        value:[]
                    }
                },
                ready:function(){
                    this._missionsListUpdate = true;
                    this.$$('#filter-toolbar').show();
                },
                _onBeginCreation: function (e) {
                    if(this.createMission){
                        this._createEmptyMission();
                        this._showPage('creation');
                    }
                },
                _onGetKinds: function(e){
                    this.set('_kinds', e.detail.kinds);
                },
                _onCreateMission: function (e) {
                    app.socket.emit('add-mission', this.mission);
                    this._createEmptyMission();
                    this._backToPreviousPage(null);
                },
                _onDeleteMission: function (e) {
                    this.mission = e.detail.mission;
                    app.socket.emit('delete-mission', this.mission);
                    this._createEmptyMission();
                    this._allowInfosOpen = false;
                },
                _onUpdateMission: function (e) {
                    app.socket.emit('update-mission', this.mission);
                    this._createEmptyMission();
                    this._backToPreviousPage(null);
                },
                _onBeginEdition: function (e) {
                    this.mission = e.detail.mission;
                },
                _onBeginConsultation: function (e) {
                    if (!this._allowInfosOpen) {
                        this._allowInfosOpen = true;
                        return;
                    }

                    var target = event.target;
                    while (target !== this && !target._templateInstance) {
                        target = target.parentNode;
                    }

                    this.mission = target._templateInstance.item;
                    this._showPage('consultation');
                },
                _onCloseInfos: function (e) {
                    this._backToPreviousPage(null);
                },
                _onCancel: function (e) {
                    this._createEmptyMission();
                    this._backToPreviousPage(null);
                },
                _onRequestLogin: function (event) {
                    this.fire('request-login', {});
                    this.$.pages.selected = 0;
                },
                _onShowMissionsOfKind: function (e) {
                    this._selectedKind = e.detail.kind;
                    this._missionsfilterAdd('kind');
                    this._showPage('missions');
                    this.$.toolbar.selected = 1;
                },
                _onSortedChanged:function(e){
                    this._missionsSort = {
                        type: e.detail.type
                    }
                },
                _onFilterAdd: function (e) {
                    this._missionsfilterAdd(e.detail.type);
                },
                _missionsfilterAdd:function(type){
                    if (!this._missionsFilter) {
                        this._missionsFilter = {
                            types: [type],
                            kind: this._selectedKind
                        }
                    }
                    else {
                        var filter = this._missionsFilter;
                        this._missionsFilter = null;
                        filter.types.push(type);
                        filter.kind = this._selectedKind;
                        this.set('_missionsFilter', filter);
                    }
                },
                _onFilterRemove: function (e) {
                    this._missionsfilterRemove(e.detail.type);
                },
                _missionsfilterRemove: function (type) {
                    var filter = this._missionsFilter;
                    this._missionsFilter = null;
                    if (filter) {
                        for (var idx = 0; idx < filter.types.length; ++idx) {
                            if (filter.types[idx] == type) {
                                filter.types.splice(idx, 1);
                                break;
                            }
                        }
                        filter.kind = this._selectedKind;
                    }
                    this.set('_missionsFilter', filter);
                },
                _backToPreviousPage: function (e) {
                    var page = this._fromPages.pop();

                    if (this.$.pages.selected === 'creation' && page == 'missions') {
                        var backpage = this._fromPages[this._fromPages.length - 1];

                        if(backpage != 'kinds' || this._mainFilter == 'missions')
                            this.$.toolbar.select(0);
                    }

                    this.createMission = false;
                    this._showPage(page);
                },
                _createEmptyMission: function () {
                    this.set('mission', new Object({
                        title: '',
                        type: '',
                        subType: '',
                        level: 1,
                        reward: 0,
                        descritpion: '',
                        status: 0,
                        creationDate: Date.now(),
                        wishDates: [],
                        where: {
                            longitude: '',
                            latitude: '',
                            address: {
                                number: '',
                                street: '',
                                state: '',
                                zip: ''
                            }
                        },
                        tasks: []
                    }));
                },
                _showPage: function (page) {
                    if(this.$.pages.selected != 'creation')
                        this._fromPages.push(this.$.pages.selected);

                    switch (page) {
                        case 'kinds':
                            //this.$.toolbar.hide();
                            this.$.toolbar.select(0);
                            this.$$('#filter-toolbar').hide();
                            break;
                        case 'missions':
                            //this._updateToolbar();
                            //this.$.toolbar.show();
                            this.$$('#filter-toolbar').show();
                            break;
                        case 'creation':
                            //this._updateToolbar();
                            //this.$.toolbar.show();
                            this.$$('#filter-toolbar').hide();
                            this.$.toolbar.select(1);
                            break;
                        case 'edition':
                            //this._updateToolbar();
                            //this.$.toolbar.show();
                            break;
                        case 'consultation':
                            //this._updateToolbar();
                            //this.$.toolbar.show();
                            break;
                    }

                    this.$.pages.select(page);
                },
                _mainFilterChange: function (e) {
                    switch (this._mainFilter) {
                        case 'missions':
                            this._selectedKind = null;
                            this._missionsfilterRemove('kind');
                            this.$.toolbar.select(0);
                            this._showPage('missions');
                            break;
                        case 'kinds': this._showPage('kinds');
                            break;
                    }
                }
            });
        })();
    </script>
</dom-module>
