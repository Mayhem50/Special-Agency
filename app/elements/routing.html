<script src="../../bower_components/page/page.js"></script>
<script>
    window.addEventListener('WebComponentsReady', function () {
        page('/', function () {
            app.route = 'home';
        });

        page('/login', function () {
            app.route = 'login';
        });

        page('/logout', function () {
            clearToken();
            isAuthenticated('home', function () {
                document.querySelector('#deconnexionToggle').hide();
            });
        });

        page('/profile/:name', function (data) {
            isAuthenticated('profile');
            app.params = data.params;
        });

        page('/users', function () {
            app.route = 'users';
        });

        page('/users/:name', function (data) {
            app.route = 'user-info';
            app.params = data.params;
        });

        page('/missions', function () {
            isAuthenticated('missions');
        });

        // add #! before urls
        page({
            hashbang: true
        });        

        
    });

    function clearToken() {
        window.localStorage.clear();
        window.sessionStorage.clear();
    }

    function isAuthenticated(route, callback) {
        $.ajax({
            url: 'http://127.0.0.1:3000/token',
            statusCode : {
                200 : function(){
                    app.route = route;
                    app.isLogged = '/profile/' + window.sessionStorage['email'];
                    if(callback)
                        callback();
                },
                403 : function(){
                    app.route = 'login';
                    app.isAuthenticated = app.route;
                    if (callback)
                        callback();
                }
            },
            type : 'POST'
        });
    }

    window.addEventListener('load', function (event) {
        if (window.localStorage['remember'] == "true") {
            window.sessionStorage.token = window.localStorage.token;
            window.sessionStorage['email'] = window.localStorage['email'];
            document.querySelector('#deconnexionToggle').show();
            $.ajaxSetup({
                headers: {
                    'x-access-token': window.sessionStorage.token
                }
            });
        }
        else {
            document.querySelector('#deconnexionToggle').hide();
        }
    });

    window.addEventListener('unload', function (event) {
        if (window.localStorage['remember'] != "true") {
            window.localStorage.token = '';
        }
    });
</script>
