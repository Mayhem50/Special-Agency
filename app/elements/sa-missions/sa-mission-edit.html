<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html" />
<link rel="import" href="../../../bower_components/paper-badge/paper-badge.html" />

<link rel="import" href="../sa-dates/sa-dates.html" />
<link rel="import" href="../sa-rank/sa-rank.html" />
<link rel="import" href="../date-picker/date-picker.html" />

<dom-module id="sa-mission-edit">
    <style>
        .description::-webkit-scrollbar-track {
            
            background-color: #ffffff;
        }

        .description::-webkit-scrollbar {
            width: 5px;
            background-color: #ffffff;
        }

        .description::-webkit-scrollbar-thumb {
            border-radius: 7px;
            background-color: #cccccc;
        }

        .taskList::-webkit-scrollbar-track {
            
            background-color: #ffffff;
        }

        .taskList::-webkit-scrollbar {
            width: 5px;
            background-color: #ffffff;
        }

        .taskList::-webkit-scrollbar-thumb {
            border-radius: 7px;
            background-color: #cccccc;
        }        
        
        .container {
            margin: 5px auto;
            width: 34.896%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            align-self: flex-end;
            background-image: url(../../images/missions/01.jpg);
            background-position: 0% 0%;
            background-repeat: no-repeat;
            background-size: 100%;
        }

        .header {
            height: 275px;
            display: flex;
            justify-content: flex-start;
            flex-flow: column;
            display: flex;
            justify-content: space-between;
            background-color:rgba(0, 0, 0, 0.20);
        }

        .middle {
            height: 48px;
            flex-direction: row;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

            .middle > div {
                margin-left: 10px;
            }

            .middle > #level {
                margin-left: 10px;
                font-size: 18px;
            }

            .middle > #stars {
                margin-right: 15px;
            }

        .footer {
            height: 485px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }


        .description {
            margin-left: 25px;
            padding-right: 25px;
            margin-top: 5px;
            overflow-y: auto;
            max-height: 477px;
            visibility: visible;
        }

        #mask {
            align-self: flex-end;
            height: 50px;
            background-color: rebeccapurple;
        }

        .gain {
            background-color: rgba(76, 255, 0, 0.00);
            font-size: 30px;
            font-weight:300;
            font-family: 'Segoe UI Symbol';
            color: rgb(0, 0, 0);
            margin: 5px auto auto 5px;
        }

        .reward {
            margin: 45px auto auto 15px;
            display:flex;
        }

        .gain > paper-input{
            width: 40%;
            --paper-input-container-input-color:black;
            --paper-input-container-input:{
                font-size:28px;
                text-align: right;
            }

            --paper-input-suffix:{
                font-size:30px;
                font-weight:400;
            }
        }

        .gain > div{
            font-size:60px;
            color:#ffffff;
        }

        .dates {
            display: flex;
            flex-flow:row;
            background-color: rgba(0, 255, 144, 0.00);
            justify-content:space-around;
            height: 30%;
            flex-wrap:nowrap;
            align-items:flex-start;
        }

        .date {
            margin: 0 2px 0 2px;
            background-color:#00ffff;
        }

        .title{
            margin: 5px 25px;
        }

        .title > paper-input{
            --paper-input-container-input-color:white;
            --paper-input-container-input:{
                                                font-size:48px;
                                                text-align:right;
                                          }
        }

        .icon{
            position:relative;
            bottom: -50px;
            left: 10px;
        }

        .taskDesc{
            flex-grow: 3;
            margin: 5px 5px 5px 25px;
        }

        .taskComment{
            flex-grow: 1;
            margin: 5px 5px;
        }

        .tasks{
            width: 100%;
        }

        .taskList{
            overflow-y: auto;
            max-height: 405px;
            margin-top: 20px;
        }

        .taskList > paper-item{
            border-radius: 5px;
            background-color: rgba(137, 137, 137, 0.81);
            width: 85%;
            z-index: 5;
            margin: 5px auto;
        }

        .task{
            width: 100%;
            display:flex;
            align-items: center;
            align-self:center;
        }

        .round{
            width:24px;
            height:24px;
            border-radius:12px;
            background-color:rgba(57, 52, 48, 0.93);
            color:white;
            font-weight:400;
            display:flex;
            justify-content:center;
            align-items:center;
        }

        #addTask{
            margin:15px 25px 0px 10px;
        }
        
        .rightButton {
            position: fixed;
            bottom: 25px;
            right: calc(50% - 17%);
            z-index:12;
        }
        
        .leftButton {
            position: fixed;
            bottom: 25px;
            left: calc(50% - 17%);
            z-index:12;
        }

        sa-rank{
            --sa-rank-item:{
                margin-left: 60px;
                padding:0;
            }
        }
    </style>
    <template>
            <div class="container">
                <div class="header">
                    <div class="title">
                        <div>[[mission.title]]</div>
                    </div>
                    <div class="gain">
                        <paper-input class="reward" type="number" value="{{mission.reward::input}}" always-float-label="false" no-label-float="true"><div suffix>€</div></paper-input>
                    </div>
                    <div class="dates">
                           <sa-dates id="datesList" dates="[[mission.wishDates]]" limit="8"></sa-dates>
                    </div>
                </div>

                <div class="middle" id="middle" style$="background-color:[[kind.color]]">
                    <div id="level">Level difficulty :</div>
                    <div id="stars">
                        <sa-rank count="4" editable="true" rank="{{mission.level}}"></sa-rank>
                    </div>
                </div>

                <div class="footer">
                    <paper-tabs selected="{{tabs}}">
                        <paper-tab>Description</paper-tab>
                        <paper-tab>Tasks</paper-tab>
                        <paper-tab>When</paper-tab>
                        <paper-tab>Where</paper-tab>
                    </paper-tabs>
                    <iron-pages selected="{{tabs}}">
                        <div>
                            <paper-textarea type="text" label="Description" class="description" value="{{mission.description::input}}"></paper-textarea>
                        </div>
                        <div class="tasks">
                            <div class="task">
                                <paper-input type="text" class="taskDesc" label="Description" value="{{task.description::input}}"></paper-input>
                                <paper-input type="text" class="taskComment" label="Comment" value="{{task.comment::input}}"></paper-input>
                                <paper-icon-button id="addTask" icon="add" on-tap="_addTask"></paper-icon-button>
                            </div>
                            <div class="taskList">
                                <template id="taskListTemplate" is="dom-repeat" items="[[mission.tasks]]">
                                    <paper-item>
                                        <div class="round">[[item.order]]</div>
                                        <div class="taskDesc">[[item.description]]</div>
                                        <div class="taskComment">[[item.comment]]</div>
                                        <paper-icon-button icon="delete" on-tap="_removeTask" id$="[[item.order]]"></paper-icon-button>
                                    </paper-item>
                                </template>
                            </div>
                        </div>
                        <div>
                            <date-picker id="datePicker" style="height:100%;" dates="{{mission.wishDates}}" edit on-date-selected="_updateDates">
                                <iron-icon prev-month icon="chevron-left"></iron-icon>
                                <iron-icon next-month icon="chevron-right"></iron-icon>
                                <iron-icon prev-year icon="chevron-left"></iron-icon>
                                <iron-icon next-year icon="chevron-right"></iron-icon>
                            </date-picker>
                        </div>
                        <div>
                            <paper-input type="text" class="description"></paper-input>
                        </div>
                    </iron-pages>
                </div>
            </div>

        <div>
            <paper-fab id="validateButton" class="rightButton" icon="check" on-click="_onValidate"></paper-fab>
            <paper-fab id="cancelButton" class="leftButton" icon="clear" on-click="_onCancel"></paper-fab>
        </div>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-mission-edit',

                properties: {
                    mission: {
                        type: Object,
                        notify: true,
                        observer: '_missionChanged'
                    },
                    kind: {
                        type: Object
                    },
                    edit: {
                        type: Boolean,
                        value: false
                    },
                    dates: {
                        type: Array,
                        value: [],
                        observer: "_updateDates"
                    },
                    tasks: {
                        type: Array,
                        value: []
                    },
                    task: {
                        type: Object,
                        value: function () {
                            return {
                                order: 1,
                                description: "",
                                comment: ""
                            }
                        }
                    },
                    level: {
                        type: Number,
                        value: 1
                    },
                    description: String,
                    create: {
                        type: Boolean,
                        value: false
                    }
                },
                ready: function () {
                    this.tabs = 0;
                },
                _updateDates: function (e) {
                    var dates = this.querySelector('sa-dates');
                    if (dates) {
                        dates.refresh();
                    }
                },
                _setLevel: function(e){
                    this.mission.level = e.target.rank;
                },
                _addTask: function (e) {
                    this.push('mission.tasks', this.task);
                    this.task = new Object({
                        order: this.mission.tasks.length + 1,
                        description: "",
                        comment: ""
                    });

                    var list = this.querySelector('#taskListTemplate');
                    list.render();

                    var div = this.querySelector(".taskList");
                    div.scrollTop = div.scrollHeight;
                },
                _removeTask: function (e) {
                    var target = event.target;
                    while (target !== this && !target._templateInstance) {
                        target = target.parentNode;
                    }

                    var item = target._templateInstance.item;

                    this.splice('mission.tasks', item.order - 1, 1);

                    for (var idx = 0; idx < this.mission.tasks.length; ++idx) {
                        this.mission.tasks[idx].order = idx + 1;
                    }
                    this.task = new Object({
                        order: this.mission.tasks.length + 1,
                        description: "",
                        comment: ""
                    });

                    var list = this.querySelector('#taskListTemplate');
                    list.render();
                },
                _onValidate: function (e) {
                    this.mission._type = this.kind._id;
                    this.fire('update-mission', { mission: this.mission });
                },
                _onCancel: function (e) {
                    this.fire('cancel');
                },
                _missionChanged: function (e) {
                    this.tabs = 0;
                    var picker = this.querySelector('date-picker');
                    if (picker) {
                        var date = new Date(Date.now());
                        picker._genTable(date.getUTCFullYear(), date.getUTCMonth());
                    }
                }
            });
        })();

    </script>
</dom-module>
