<script src="../../bower_components/page/page.js"></script>
<script>
    window.addEventListener('WebComponentsReady', function () {
        page('/', function () {
            app.route = 'home';
        });

        page('/login', function () {
            app.route = 'login';
        });

        page('/logout', function () {
            clearToken();

            $.ajax({
                url: '/users/logout',                
                type : 'POST'
            });

            isAuthenticated('home', null, function () {
                document.getElementById('deconnexionToggle').hide();
            });
        });

        page('/profile/:name', function (data) {
            isAuthenticated('profile');
            app.params = data.params;
        });

        page('/users', function () {
            app.route = 'users';
        });

        page('/users/:name', function (data) {
            app.route = 'user-info';
            app.params = data.params;
        });

        page('/missions', function () {
            isAuthenticated('missions', function () {
                app.notification = !app.notification;
            });
        });

        // add #! before urls
        page({
            hashbang: true
        });        

        
    });

    function clearToken() {
        window.localStorage.clear();
        window.sessionStorage.clear();
    }

    function isAuthenticated(route, successCb, failCb) {
        $.ajax({
            url: '/token',
            data: {
                access_token : window.sessionStorage.token
            },
            statusCode : {
                200 : function(){
                    app.route = route;
                    app.isLogged = '/profile/' + window.sessionStorage['email'];
                    if (successCb)
                        successCb();
                },
                403 : function(){
                    app.route = 'login';
                    app.isAuthenticated = app.route;
                    if (failCb)
                        failCb();
                }
            },
            type : 'POST'
        });
    }

    window.addEventListener('load', function (event) {
        if (window.localStorage['remember'] == "true") {
            window.sessionStorage.token = window.localStorage.token;
            window.sessionStorage['email'] = window.localStorage['email'];
            document.getElementById('deconnexionToggle').show();            
        }
        else {
            document.getElementById('deconnexionToggle').hide();
        }

        app.notification = false;
    });

    window.addEventListener('unload', function (event) {
        if (window.localStorage['remember'] != "true") {
            window.localStorage.token = '';
        }
    });
</script>
