<link rel="import" href="../../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="sa-mission-creation.html">
<link rel="import" href="sa-mission-infos.html">
<link rel="import" href="sa-mission-card.html">

<dom-module id="sa-missions">
    <style>
        neon-animated-pages {
            height: 100%;
        }

        paper-fab {
            background-color: #118c89;
        }

        .createButton {
            position: fixed;
            bottom: 25px;
            right: 40px;
        }        

        .container {
            padding: 4px;
            margin: 1px auto;
            width: 55%;
            display:flex;
            flex-wrap:wrap;
        }
    </style>
    <template>
            <iron-pages id="pages" selected="0">
                <div class="container">
                    <sa-mission-creation id="mission-creation"></sa-mission-creation>
                    <template is="dom-repeat" items="[[missions]]">
                       <sa-mission-card></sa-mission-card>
                    </template>
                </div>

                
                
            </iron-pages>

        <div>
            <paper-fab id="createButton" class="createButton" icon="create" on-click="_onCreateMissionClick"></paper-fab>
        </div>
        
        <iron-ajax id="mission-ajax"
                   url="[[ajax_url]]"
                   content-type="application/json"
                   body="[[ajax_params]]"
                   handle-as="json"
                   method="[[ajax_method]]"
                   on-response="handleResponse"
                   last-response="{{ajax_response}}">
        </iron-ajax>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-missions',

                behaviors: [
                    Polymer.NeonAnimationRunnerBehavior
                ],

                properties: {
                    notification: {
                        type: Boolean,
                        notify: true,
                        observer: 'handleNotification'
                    },
                    animationConfig: {
                        type: Object,
                        value: function () {
                            return {
                                'entry': [{
                                    name: 'scale-down-animation',
                                    toPage: this,
                                    node: this.$.createButton
                                }],
                                'exit': [{
                                    name: 'scale-up-animation',
                                    node: this.$.createButton
                                }]
                            }
                        }
                    },
                    ajax_params: {
                        type: Object,
                        value: function () {
                            return {
                                mission: new Object(),
                                access_token: ''
                            }
                        }
                    },
                    mission: {
                        type : Object,
                        value: function () {
                            return {
                                //_id: '',
                                title: '',
                                type: '',
                                subType: '',
                                level: 0,
                                reward: 0,
                                descritpion: '',
                                status: 0,
                                creationDate: Date.now(),
                                todoDate: Date.now() + 7,
                                where: {
                                    longitude: '',
                                    latitude: '',
                                    address: {
                                        number: '',
                                        street: '',
                                        state: '',
                                        zip: ''
                                    }
                                }
                            }
                        }
                    },
                    opened: {
                        type: Boolean
                    },
                    ajax_response: {
                        type: Object,
                        notify: true
                    },
                    ajax_method: {
                        type: String,
                    },
                    ajax_url: {
                        type: String,
                        value: '/missions'
                    },
                    filter: {
                        type: String,
                        value: 'none',
                        notify: true
                    },
                    _isForEdit: {
                        type: Boolean,
                        value: false
                    }
                },
                listeners: {
                    'neon-animation-finish': '_onNeonAnimationFinish'
                },
                ready: function () {
                    Array.prototype.indexOfObject = function (property, value) {
                        for (var i = 0, len = this.length; i < len; i++) {
                            if (this[i][property] === value) return i;
                        }
                        return -1;
                    };

                    app.socket.on('add-mission', function (data) {
                        console.log('add mission');
                        this.$.list.push('missions', data);
                    }.bind(this));
                    app.socket.on('update-mission', function (data) {
                        console.log('update mission');
                        var index = this.$.list.missions.indexOfObject('_id', data._id);
                        this.$.list.splice('missions', index, 1);
                        this.$.list.push('missions', data);
                    }.bind(this));
                    app.socket.on('delete-mission', function (data) {                        
                        console.log('delete mission');
                        var index = this.$.list.missions.indexOfObject('_id', data._id);
                        this.$.list.splice('missions', index, 1);
                    }.bind(this));
                },
                _onNeonAnimationFinish: function () {
                    if (!this.opened) {
                        this.$.createButton.style.display = 'none';
                    }
                },
                handleNotification: function () {
                    if (window.sessionStorage.token !== "undefined" && window.sessionStorage.token != '') {
                        if (app.drawer_route == 0) {                            
                            this.filter = app.mission_filter;
                        }
                        else if (app.drawer_route == 1) {
                            this.filter = 'sponsor';
                        }
                        else {
                            this.filter = 'none';
                        }
                    }
                    else {
                        this.filter = 'none';
                    }
                    this.getMissions();
                },
                getMissions: function () {
                    this.ajax_method = 'GET';
                    this.ajax_url = '/missions'
                    this.sendRequest();
                },
                sendRequest: function () {
                    this.ajax_params.access_token = window.sessionStorage.token;
                    this.ajax_params.mission = this.mission;
                    this.querySelector('iron-ajax').generateRequest();
                },
                handleResponse: function () {
                    if (!this.ajax_response) {
                        return;
                    }

                    if (this.ajax_response.success) {
                        if (this.ajax_response.method === 'POST' || 
                            this.ajax_response.method === 'PUT' ||
                            this.ajax_response.method === 'DELETE') {
                            //this.getMissions();
                        }
                        else if (this.ajax_response.method === 'GET') {
                            this.missions = this.ajax_response.missions;
                        }
                    }
                },
                _onCreateMissionClick: function (event) {
                    this._isForEdit = false;
                    this.querySelector('sa-missions-list').setAnimationConfig(event.x || event.pageX, event.y || event.pageY);
                    this._opendCreationView(false);
                },
                _onMissionCreationClose: function (e) {
                    if (e.detail.validate) {
                        if(!this._isForEdit){
                            app.socket.emit('add-mission', this.mission);
                            this.mission = {};
                        }
                        else if (this._isForEdit) {  
                            var date = new Date(Date.now());
                            this.mission.creationDate = date.toISOString();
                            app.socket.emit('update-mission', this.mission);
                            this.mission = {};
                        }
                    }
                    this.$.pages.selected = 0;
                    this._playButtonAnimation(true);                    
                },
                _onMissionClick: function (e) {
                    this.mission = e.detail.data;
                    this.$.pages.selected = 1;
                    this._playButtonAnimation(false);
                },
                _onCloseMission: function (e) {
                    this.$.pages.selected = 0;
                    this._playButtonAnimation(true);
                },
                _playButtonAnimation: function (goVisible) {
                    if (goVisible) {
                        this.opened = true;
                        this.$.createButton.style.display = '';
                        this.playAnimation('exit');
                    }
                    else {
                        this.opened = false;
                        this.playAnimation('entry');
                    }
                },
                _onAcceptMission: function () {
                    this.ajax_method = 'PUT';                
                    this.ajax_url = '/missions/accept';
                    this.sendRequest();
                    this.$.pages.selected = 0;
                    this._playButtonAnimation(true);
                },
                _onRequestLogin: function (event) {
                    this.fire('request-login', {});
                    this.$.pages.selected = 0;
                    this._playButtonAnimation(true);
                },
                _onMissionDelete: function (event) {
                    app.socket.emit('delete-mission', event.detail.data);
                    //this.ajax_method = 'DELETE';
                    //this.mission = event.detail.data;
                    //this.ajax_url = '/missions/' + event.detail.data._id;
                    //this.sendRequest();
                },
                _onMissionEdit: function (event) {
                    this.mission = event.detail.data;
                    this._opendCreationView(true);
                },
                _opendCreationView: function (isForEdit) {
                    if (!app.isLogged) {
                        this._onRequestLogin();
                        return;
                    }
                    this.animationConfig['exit'][0].gesture = {
                        x: event.x || event.pageX,
                        y: event.y || event.pageY
                    };

                    this.$.pages.selected = 2;
                    this._playButtonAnimation(false);
                    this._isForEdit = isForEdit;
                }
            });
        })();               
    </script>
</dom-module>
