
<link rel="import" href="../sa-xhr/sa-xhr.html" />

<dom-module id="sa-model">
    <style>
        :host {
            display: none !important;
        }
    </style>
    <template>
        <sa-xhr id="missions"
                url="/missions"
                method="get"
                result="{{model.missions}}"></sa-xhr>

        <sa-xhr id="kinds"
                url="/kinds"
                method="get"
                result="{{model.kinds}}"></sa-xhr>
        
        <sa-xhr id="chats"
                url="[[_chatsURL]]"
                method="get"
                result="{{model.chats}}"
                token></sa-xhr>

        <sa-xhr id="favorite-missions"
                url="/favorite-missions"
                method="get"
                result="{{model.favoriteMissions}}"
                token></sa-xhr>

        <sa-xhr id="draft-missions"
                url="/favorite-missions"
                method="get"
                result="{{model.draftMissions}}"
                token></sa-xhr>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-model',
                properties: {
                    _chatsURL: String,
                    model: {
                        type: Object,
                        value: function () {
                            return {                                
                                missions : [],
                                kinds : [],
                                chats: [],
                                favoriteMissions: [],
                                draftMissions: []
                            }
                        },
                        notify : true
                    }
                },
                debug: function (e) {
                    console.log(e);
                },
                attached: function (e) {
                    if (app.user) {
                        this._chatsURL = '/chats/' + app.user._id;
                    }

                    var xhrs = this.querySelectorAll('sa-xhr');
                    if (xhrs) {
                        for (var idx = 0; idx < xhrs.length; ++idx) {
                            xhrs[idx].request();
                        }
                    }

                    app.addEventListener('socket-connected', function (e) {
                        app.socket.on('new-chat', function (data) {
                            console.log('add chat');
                            if (this.model.chats.indexOfObject('_id', data._id) != -1) { return; }
                            this.push('model.chats', data);
                        }.bind(this));

                        app.socket.on('new-message', function (data) {
                            console.log('new message');
                            var index = this.model.chats.indexOfObject('_id', data.chat._id);
                            if (index == -1) { return; }
                            this.push('model.chats.' + index + '.messages', data.message);

                            if (app.user._id == data.chat._sponsor._id) {
                                this.set('model.chats.' + index + '.sponsorUnreads', this.model.chats[index].sponsorUnreads + 1);
                            }
                            else if (app.user._id == data.chat._agent._id) {
                                this.set('model.chats.' + index + '.agentUnreads', this.model.chats[index].agentUnreads + 1);
                            }
                        }.bind(this));

                        app.socket.on('read-chat', function (data) {
                            console.log('read chat');
                            var index = this.model.chats.indexOfObject('_id', data._id);
                            if (index == -1) { return; }

                            if (app.user._id == data._sponsor._id) {
                                this.set('model.chats.' + index + '.sponsorUnreads', data.sponsorUnreads);
                            }
                            else if (app.user._id == data._agent._id) {
                                this.set('model.chats.' + index + '.agentUnreads', data.agentUnreads);
                            }
                        }.bind(this));

                        app.socket.on('update-chat', function (data) {
                            console.log('update chat');
                            var index = this.model.chats.indexOfObject('_id', data._id);
                            if (index == -1) { return; }
                            this.set('model.chats.' + index, data);
                        }.bind(this));

                        app.socket.on('add-mission', function (data) {
                            console.log('add mission');
                            this.push('model.missions', data);
                            if (data.status == 'draft') {
                                app.socket.emit('add-draft-mission', { _mission: data.mission._id });
                            }
                        }.bind(this));

                        app.socket.on('update-mission', function (data) {
                            console.log('update mission');
                            var index = this.model.missions.indexOfObject('_id', data._id);
                            if (index == -1) { return; }
                            this.set('model.missions.' + index, data);
                        }.bind(this));

                        app.socket.on('delete-mission', function (data) {
                            console.log('delete mission');
                            var index = app.missions.indexOfObject('_id', data._id);
                            if (index == -1) { return; }
                            this.splice('model.missions', index, 1);
                        }.bind(this));

                        app.socket.on('add-kind', function (data) {
                            console.log('add kind');
                            this.push('model.kinds', data);
                        }.bind(this));

                        app.socket.on('update-kind', function (data) {
                            console.log('update kind');
                            var index = app.kinds.indexOfObject('_id', data._id);
                            this.splice('kinds', index, 1);
                            this.push('kinds', data);
                        }.bind(this));

                        app.socket.on('delete-kind', function (data) {
                            console.log('delete kind');
                            var index = app.kinds.indexOfObject('_id', data._id);
                            this.splice('kinds', index, 1);
                        }.bind(this));

                        app.socket.on('add-favorite-mission', function (data) {
                            console.log('add favorite mission');
                            var index = this.model.favoriteMissions.indexOfObject('_id', data._id);
                            if (index != -1) { return; }
                            this.push('model.favoriteMissions', data);
                        }.bind(this));

                        app.socket.on('delete-favorite-mission', function (data) {
                            console.log('delete favorite mission');
                            var index = this.model.favoriteMissions.indexOfObject('_id', data._id);
                            if (index == -1) { return; }
                            this.splice('model.favoriteMissions', index, 1);
                        }.bind(this));

                        app.socket.on('add-draft-mission', function (data) {
                            console.log('add draft mission');
                            var index = this.model.draftMissions.indexOfObject('_id', data._mission);
                            if (index != -1) { return; }
                            this.push('model.favoriteMissions', data);
                        }.bind(this));

                        app.socket.on('delete-draft-mission', function (data) {
                            console.log('delete draft mission');
                            var index = this.model.draftMissions.indexOfObject('_id', data._id);
                            if (index == -1) { return; }
                            this.splice('model.favoriteMissions', index, 1);
                        }.bind(this));
                    }.bind(this));
                }
            });
        })();

    </script>
</dom-module>
