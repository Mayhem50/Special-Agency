
<link rel="import" href="../../../bower_components/google-apis/google-maps-api.html" />
<link rel="import" href="../../../bower_components/google-map/google-map.html" />
<link rel="import" href="../../../bower_components/google-map/google-map-search.html" />

<dom-module id="sa-map">
    <style>
        :host {            
            --paper-input-container-input-color: #cccccc;
            --paper-input-container-input:{
                color:#cccccc;
            }
            
            --paper-input-container:{
                padding: 4px;
                background-color: rgba(0, 0, 0, 0.75);
                margin-left: 7px;
                border-radius: 5px;
                flex-grow: 1;
                vertical-align: central;
                width:528px;
            };

            --paper-input-container-underline: {
                height: 0;
            };

            --paper-input-container-underline-focus: {
                height: 0;
            };

            --paper-input-container-underline-disabled: {
                height: 0;
            };
        }

        google-map {
            width: 550px;
            height: 300px;
            float: left;
        }

        .map-input {
            position: absolute;
            margin-top: 266px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
    <template>
        <google-maps-api on-api-load="mapApiLoaded" libraries="{{libraries}}"></google-maps-api>
        <google-map-search id="search" map="[[map]]" query="street_address" results="{{results}}"></google-map-search>
        <google-map map="{{map}}" longitude="{{_longitude}}" latitude="{{_latitude}}" zoom="15" disable-default-ui></google-map>

        <paper-input id="autocomplete" class="map-input" always-float-label="false" no-label-float="true"></paper-input>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-map',

                properties: {
                    _longitude: Number,
                    _latitude: Number,
                    version: '3.exp',
                    libraries: "places",
                    placeId: {
                        type: String,
                        observer: '_placeIdChanged'
                    }
                },
                ready: function () {
                    this._getLocation();
                },
                mapApiLoaded: function (e) {
                    this.autocomplete = new google.maps.places.Autocomplete(this.$.autocomplete);
                    google.maps.event.addListener(this.autocomplete, 'place_changed', function () {
                        var place = this.autocomplete.getPlace();
                        this.location = place.formatted_address;

                        this._longitude = place.geometry.location.lng();
                        this._latitude = place.geometry.location.lat();

                        this.placeId = place.place_id;
                    }.bind(this));
                },
                _getLocation: function () {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            this.set('_longitude', position.coords.longitude);
                            this.set('_latitude', position.coords.latitude);
                        }.bind(this));
                    }
                },
                _addressChanged: function (e) {
                    var div = this.querySelector('google-map-search');
                    if (div)
                        div.search();
                },
                _placeIdChanged: function (e) {
                    if (this.placeId) {
                        var details = this.$.search.getDetails(this.placeId);
                        return details;
                    }
                }
            });
        })();

    </script>
</dom-module>

