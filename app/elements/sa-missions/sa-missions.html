<link rel="import" href="../../../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../../../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../../../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="sa-mission-creation-card.html">
<link rel="import" href="sa-mission-infos.html">
<link rel="import" href="sa-mission-card.html">
<link rel="import" href="sa-mission-kind-card.html">

<dom-module id="sa-missions">
    <style>
        neon-animated-pages {
            height: 100%;
        }

        paper-fab {
            background-color: #118c89;
        }

        .card {
            min-width: 300px;
            max-width: 300px;
            margin: 15px 10px;
            align-self: center;
        }

        .card-2 {
            min-width: 620px;
            max-width: 620px;
            margin: 15px 10px;
            align-self: center;
        }

        .card-3 {
            min-width: 940px;
            max-width: 940px;
            margin: 15px 10px;
            align-self: center;
        }

        .createButton {
            position: fixed;
            bottom: 25px;
            right: 40px;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
        }

        .grid {
            padding: 4px;
            margin: 1px auto;
            width: 55%;
            display: flex;
            flex-wrap: wrap;
        }

        .toolbar {
            display: flex;
            width: 100%;
            height: 50px;
            margin: 0;
            background-color: #3d3d3d;
        }

        #toolbar-image {
            flex: 0 0 357px;
            order: 2;
        }

        #toolbar-text {
            display: flex;
            color: #d9d9d9;
            background-color: #3d3d3d;
            flex: 1 0 210px;
            order: 3;
            padding-left: 25px;
            align-items: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        #toolbar-button {
            display: flex;
            flex: 0 0 50px;
            order: 1;
            height: 100%;
            justify-content: flex-start;
            align-items: center;
            color: #686868;
            background-color: #2b2b2b;
        }

            #toolbar-button > paper-icon-button {
                padding: 0;
            }

        #toolbar-deco {
            flex: 0 0 40px;
            order: 4;
            height: 100%;
        }
    </style>
    <template>
        <div class="container">
            <iron-collapse id="toolbar">
                <div class="toolbar">
                    <div id="toolbar-button"><paper-icon-button icon="chevron-left" on-tap="_backToKinds"></paper-icon-button></div>
                    <div id="toolbar-image">&nbsp;</div>
                    <div id="toolbar-text"><span>&nbsp;</span><span>[[_selectedKind.name.en]]</span></div>
                    <div id="toolbar-deco">&nbsp;</div>
                </div>
            </iron-collapse>
            <iron-pages id="pages" selected="0">
                <div class="grid">
                    <sa-mission-creation-card class="card"
                                              count="[[_missions.length]]"
                                              kinds="[[_kinds]]"
                                              on-create-mission="_onBeginCreation"
                                              on-kind-change="_changeKind">
                    </sa-mission-creation-card>
                    <template is="dom-repeat" items="[[_kinds]]" observe="count">
                        <sa-mission-kind-card class$="[[item.class]]"
                                              kind="[[item]]"
                                              on-tap="_showKindMissions">
                        </sa-mission-kind-card>
                    </template>
                </div>

                <div class="grid">
                    <sa-mission-creation-card class="card"
                                              count="[[_count]]"
                                              kinds="[[_kinds]]"
                                              kind="{{_selectedKind}}"
                                              on-create-mission="_onBeginCreation">
                    </sa-mission-creation-card>
                    <template id="missionsList" is="dom-repeat" items="[[_missions]]" filter="_filterMissions" sort="_sortMissions">
                        <sa-mission-card class="card"
                                         on-tap="_onOpenInfos"
                                         mission="[[item]]"
                                         kind="[[_selectedKind]]"
                                         index="[[index]]"
                                         on-delete-mission="_onDeleteMission"
                                         on-edit-mission="_onEditMission"
                                         hide="[[hide]]">
                        </sa-mission-card>
                    </template>
                </div>
                <div>
                    <sa-mission-infos mission="{{mission}}"
                                      edit="[[_isForEdit]]"
                                      create="[[_isForCreate]]"
                                      kind="[[_selectedKind]]"
                                      on-create-mission="_onCreateMission"
                                      on-update-mission="_onUpdateMission"
                                      on-close-infos="_onCloseInfos"
                                      on-cancel="_onCancel">
                    </sa-mission-infos>
                </div>
            </iron-pages>

            <div>
                <paper-fab id="createButton" class="createButton" icon="create" on-click="_onCreateMissionClick"></paper-fab>
            </div>
        </div>

        <iron-ajax id="mission-ajax"
                   url="[[ajax_url]]"
                   content-type="application/json"
                   params="[[ajax_params]]"
                   handle-as="json"
                   method="[[ajax_method]]"
                   on-response="handleResponse"
                   last-response="{{ajax_response}}">
        </iron-ajax>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-missions',

                behaviors: [
                    Polymer.NeonAnimationRunnerBehavior
                ],

                properties: {
                    notification: {
                        type: Boolean,
                        notify: true,
                        observer: 'handleNotification'
                    },
                    ajax_params: {
                        type: Object,
                        value: function () {
                            return {
                                mission: new Object(),
                                access_token: ''
                            }
                        }
                    },
                    mission: Object,
                    opened: Boolean,
                    ajax_response: {
                        type: Object,
                        notify: true
                    },
                    ajax_method: String,
                    ajax_url: {
                        type: String,
                        value: '/missions'
                    },
                    filter: {
                        type: String,
                        value: 'none',
                        notify: true
                    },
                    _isForEdit: {
                        type: Boolean,
                        value: false
                    },
                    _missions: {
                        type: Array,
                        value: []
                    },
                    _kinds: {
                        type: Array,
                        value: []
                    },
                    _count: Number,
                    _allowInfosOpen: {
                        type: Boolean,
                        value: true
                    }
                },
                ready: function () {
                    Array.prototype.indexOfObject = function (property, value) {
                        for (var i = 0, len = this.length; i < len; i++) {
                            if (this[i][property] === value) return i;
                        }
                        return -1;
                    };

                    this.$.toolbar.hide();
                    this._createEmptyMission();

                    app.socket.on('add-mission', function (data) {
                        console.log('add mission');
                        this.push('_missions', data);
                        var index = this._kinds.indexOfObject('_id', data._type);
                        this.set('_kinds.' + index + '.count', this._kinds[index].count + 1);
                    }.bind(this));

                    app.socket.on('update-mission', function (data) {
                        console.log('update mission');
                        var index = this._missions.indexOfObject('_id', data._id);
                        this.splice('_missions', index, 1);
                        this.push('_missions', data);
                    }.bind(this));

                    app.socket.on('delete-mission', function (data) {
                        console.log('delete mission');
                        var index = this._missions.indexOfObject('_id', data._id);
                        this.splice('_missions', index, 1);
                        var index = this._kinds.indexOfObject('_id', data._type);
                        this.set('_kinds.' + index + '.count', this._kinds[index].count - 1);
                    }.bind(this));

                    this._showPage(0);

                    this.getMissions();
                },
                attached: function () {

                },
                handleNotification: function () {
                    this.hide = true;
                    if (window.sessionStorage.token !== "undefined" && window.sessionStorage.token != '') {
                        if (app.drawer_route == 0) {
                            this.filter = app.mission_filter;
                        }
                        else if (app.drawer_route == 1) {
                            this.filter = 'sponsor';
                            this.hide = false;
                        }
                        else {
                            this.filter = 'none';
                        }
                    }
                    else {
                        this.filter = 'none';
                    }

                    this.$.missionsList.render();
                },
                getMissions: function () {
                    this.ajax_method = 'GET';
                    this.ajax_url = '/missions'
                    this.sendRequest();
                },
                getKinds: function () {
                    this.ajax_method = 'GET';
                    this.ajax_url = '/kinds'
                    this.sendRequest();
                },
                sendRequest: function () {
                    this.ajax_params.access_token = window.sessionStorage.token;
                    this.querySelector('iron-ajax').generateRequest();
                },
                handleResponse: function () {
                    if (!this.ajax_response) {
                        return;
                    }

                    if (this.ajax_response.success) {
                        if (this.ajax_response.method === 'GET') {
                            if (this.ajax_response.route === "missions") {
                                this._missions = this.ajax_response.missions;
                                this._count = this._missions.length;
                                this.getKinds();
                            }
                            else if (this.ajax_response.route === "kinds") {
                                this._kinds = this.ajax_response.kinds;
                                this._selectedKind = this._kinds[0];

                                this._kinds.forEach(function (element, index, array) {
                                    if (element.size === 1) {
                                        element.class = 'card';
                                    }
                                    else if (element.size === 2) {
                                        element.class = 'card-2';
                                    }
                                    else if (element.size === 3) {
                                        element.class = 'card-3';
                                    }
                                });
                            }
                        }
                    }
                },
                _onBeginCreation: function (e) {
                    this._createEmptyMission();

                    this.mission.title = e.detail.title || "";
                    this.mission._type = e.detail.kind._id;
                    this.mission.reward = e.detail.reward || 0;

                    this._isForEdit = true;
                    this._isForCreation = true;

                    this._showPage(2);
                },
                _onCreateMission: function (e) {
                    app.socket.emit('add-mission', this.mission);
                    this._createEmptyMission();
                    this._showPage(this._fromPage);
                },
                _onDeleteMission: function (e) {
                    this.mission = e.detail.mission;
                    app.socket.emit('delete-mission', this.mission);
                    this._createEmptyMission();
                    this._allowInfosOpen = false;
                },
                _onUpdateMission: function (e) {
                    app.socket.emit('update-mission', this.mission);
                    this._createEmptyMission();
                    this._showPage(this._fromPage);
                    this._isForEdit = false;
                },
                _onEditMission: function (e) {
                    this.mission = e.detail.mission;
                    this._isForEdit = true;
                    this._isForCreate = false;
                },
                _onOpenInfos: function (e) {
                    if (!this._allowInfosOpen) {
                        this._allowInfosOpen = true;
                        return;
                    }

                    var target = event.target;
                    while (target !== this && !target._templateInstance) {
                        target = target.parentNode;
                    }

                    this.mission = target._templateInstance.item;
                    this._showPage(2);
                },
                _onCloseInfos: function (e) {
                    this._showPage(0);
                },
                _onCancel: function (e) {
                    this._createEmptyMission();
                    this._showPage(this._fromPage);
                },
                _onRequestLogin: function (event) {
                    this.fire('request-login', {});
                    this.$.pages.selected = 0;
                },
                _showKindMissions: function (e) {
                    this._selectedKind = e.model.item;
                    this._showPage(1);
                    this.$.missionsList.render();
                },
                _filterMissions: function (item) {
                    if (!window.sessionStorage.token) {
                        return this._missionsOfKind(item);
                    }
                    else if (this.filter === 'search') {
                         return (this._missionsOfKind(item) && item._owner !== window.sessionStorage['id'] && item._agent !== window.sessionStorage['id']);
                    }
                    else if (this.filter === 'event') {
                        return (this._missionsOfKind(item) && item._owner !== window.sessionStorage['id'] && item._agent === window.sessionStorage['id']);
                    }
                    else if (this.filter === 'sponsor') {
                        return this._missionsOfKind(item) && item._owner == window.sessionStorage['id'];
                    }

                    return true;
                },
                _missionsOfKind: function (item) {
                    if (typeof (this._selectedKind) !== "undefined") {
                        if (item._type === this._selectedKind._id) {
                            return true;
                        }
                    }

                    return false;
                },
                _sortMissions: function (a, b) {
                    var A = new Date(a.creationDate);
                    var B = new Date(b.creationDate);

                    return A < B;
                },
                _backToKinds: function (e) {
                    this._showPage(0);
                },
                _changeKind: function (e) {
                    this._selectedKind = e.detail.kind;
                },
                _createEmptyMission: function () {
                    this.set('mission', new Object({
                        title: '',
                        type: '',
                        subType: '',
                        level: 1,
                        reward: 0,
                        descritpion: '',
                        status: 0,
                        creationDate: Date.now(),
                        wishDates: [],
                        where: {
                            longitude: '',
                            latitude: '',
                            address: {
                                number: '',
                                street: '',
                                state: '',
                                zip: ''
                            }
                        },
                        tasks: []
                    }));
                },
                _showPage: function (page) {
                    this._fromPage = this.$.pages.selected;

                    switch (page) {
                        case 0:
                            $('#createButton').show();
                            this.$.toolbar.hide();
                            break;
                        case 1:
                            $('#createButton').show();
                            this._updateToolbar();
                            this.$.toolbar.show();
                            break;
                        case 2:
                            $('#createButton').hide();
                            this._updateToolbar();
                            this.$.toolbar.show();
                            break;
                    }

                    this.$.pages.selected = page;
                },
                _updateToolbar: function () {
                    var div = this.querySelector('#toolbar-deco');
                    if (div == null) { return; }
                    div.style.background = this._selectedKind.color;

                    div = this.querySelector('#toolbar-image');
                    if (div == null) { return; }
                    div.style.backgroundImage = 'url(../../images/kinds/' + this._selectedKind.image.path + ')';
                    div.style.backgroundPosition = this._selectedKind.image.toolBarXOffset + ' ' + this._selectedKind.image.toolBarYOffset;
                    div.style.backgroundSize = this._selectedKind.image.toolBarScale;
                },
                _handleNeedUpdate: function (e) {
                    if (this._needUpdate) {
                        this.$.missionsList.render();
                        this._needUpdate = false;
                    }
                }
            });
        })();
    </script>
</dom-module>
