<dom-module id="sa-login">
    <style>
        .login{
            border-radius: 2px;
            height: 100%;
            padding: 16px 0 16px 0;
            width: calc(98.66% - 16px);
            margin: 16px auto;
            background: white;
        }
            
        .form{
            padding: 0px 20px 20px 20px;
        }

        .title {
            font-size: 34px;
            padding: 20px 20px 0px 20px;
        }
    </style>
    <template is="dom-bind">

        <paper-material class="login" elevation="1">
            <h2 class="title">Loggin</h2>

            <div class="form">
                <paper-input id="username" is="username" label="Username" name="username" value="{{infos.username::input}}" on-keyup="checkUserName" error-message="Name albready used"></paper-input>
                <paper-input id="password" is="password" label="Password" type="password" name="password" value="{{infos.password::input}}"></paper-input>

                <iron-collapse id="togglePart" tabindex="0">
                    <paper-input id="passwordConfirm" is="passwordConfirm" type="password" label="Confirm Password" value="{{passwordConfirm}}" error-message="Not same password"></paper-input>
                    <paper-input id="email" is="email" label="Email" name="email" value="{{infos.email::input}}" error-message="{{emailErrorMessage}}" on-keyup="checkEmail"></paper-input>
                </iron-collapse>

                </br>
                <paper-checkbox is="remember" label="Remember Me" checked="{{remember}}">Remember Me</paper-checkbox>
                
                </br>                
                </br>
                <paper-button id="SendButton" on-click="send" raised>{{sendButtonText}}</paper-button>
                </br>
                <paper-button id="ToggleButton" on-click="toggle">{{toggleButtonText}}</paper-button>
            </div>

            <span>Response is: </span><span>{{response.message}}</span>

        </paper-material>

        <iron-ajax id="login-ajax"
                   url="{{route}}"
                   params="{{infos}}"
                   handle-as="json"
                   method="post"
                   on-response="handlePassportResponse"
                   last-response="{{response}}">
        </iron-ajax>
        <iron-ajax id="check-availability-ajax"
                   url="{{availabilityRoute}}"
                   params="{{infos}}"
                   handle-as="json"
                   method="post"
                   on-response="handleAvaibilityResponse"
                   last-response="{{response}}">
        </iron-ajax>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-login',
                properties: {
                    infos: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {
                                username: '',
                                password: '',
                                email: ''
                            }
                        }
                    },
                    remember:{
                        type: Boolean,
                        value: true
                    },
                    passwordConfirm: {
                        type: String
                    },
                    emailErrorMessage: {
                        type: String,
                        value : 'Not an email'
                    },
                    route: {
                        type: String,
                        value: 'signin'
                    },
                    availabilityRoute: {
                        type: String,
                        value: ''
                    },
                    response: {
                        type: Object,
                        notify: true,
                        value: function () {
                            message: ""
                        }
                    },
                    sendButtonText: {
                        type: String,
                        value: "Sign In"
                    },
                    toggleButtonText: {
                        type: String,
                        value: "Sign Up"
                    },
                    isForLogin:{
                        type: Boolean,
                        value: true
                    }
                },
                ready: function () { 
                    
                },
                send: function () {
                    console.log(this.infos);
                    if (this.validateBeforeSend())
                        document.getElementById('login-ajax').generateRequest();
                },
                handlePassportResponse: function () {
                    console.log('handle passport response');
                    console.log(this.response);

                    if (typeof this.response == "undefined" || this.response == null) {
                        return;
                    }

                    if (this.response.isAuthenticated) {
                        document.querySelector('#deconnexionToggle').show();                        

                        if (this.remember === true) {
                            window.localStorage.token = this.response.token;
                            window.localStorage.remember = true;
                            window.localStorage.setItem('username', this.infos.username);
                        }
                        else {
                            window.sessionStorage.token = this.response.token;
                            window.sessionStorage.setItem('username', this.infos.username);
                        }

                        app.route = 'home';
                        app.isLogged = '/profile/' + this.infos.username;

                        this.infos = function () {
                            return {
                                username: '',
                                password: '',
                                email: ''
                            }
                        }
                    }
                },
                toggle: function (event, detail, sender) {
                    var val = document.querySelector('#togglePart').toggle();

                    if (this.sendButtonText === "Sign In") {
                        this.sendButtonText = "Sign Up";
                        this.toggleButtonText = "Sign In";
                        this.route = "https://127.0.0.1:3000/signup";
                        this.isForLogin = false;
                    }
                    else {
                        this.sendButtonText = "Sign In";
                        this.toggleButtonText = "Sign Up";
                        this.route = "https://127.0.0.1:3000/signin";
                        this.isForLogin = true;
                    }
                },
                checkEmail: function () {
                    this.availabilityRoute = "https://127.0.0.1:3000/checkAvailability/email";
                    var regex = new RegExp("^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$");
                    if (!regex.test(this.infos.email)) {
                        this.emailErrorMessage = 'Not an email';
                        document.getElementById('email').invalid = true;
                    }
                    else {
                        document.getElementById('email').invalid = false;
                    }
                    document.getElementById('check-availability-ajax').generateRequest();
                },
                checkUserName: function () {
                    this.availabilityRoute = "https://127.0.0.1:3000/checkAvailability/username";
                    document.getElementById('check-availability-ajax').generateRequest();
                },
                handleAvaibilityResponse: function () {
                    console.log('handle availability response');
                    console.log(this.response);

                    if (typeof this.response == "undefined" || this.response == null) {
                        return;
                    }

                    if(this.response.isUsername){
                        if (!this.response.isFree) {
                            document.getElementById('username').invalid = true;
                        }
                        else {
                            document.getElementById('username').invalid = false;
                        }
                    }
                    else {
                        if (!this.response.isFree) {
                            this.emailErrorMessage = 'Email albready used';
                            document.getElementById('email').invalid = true;
                        }
                        else{
                            var regex = new RegExp("^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$");
                            if (!regex.test(this.infos.email)) {
                                this.emailErrorMessage = 'Not an email';
                                document.getElementById('email').invalid = true;
                            }
                        }
                    }
                },
                validateBeforeSend: function (event, detail, sender) {
                    if (!this.isForLogin) {
                        this.checkUserName;
                        if( this.infos.password !== this.passwordConfirm){
                            document.getElementById('password').invalid = true;
                            document.getElementById('passwordConfirm').invalid = true;
                        }
                        else {
                            document.getElementById('password').invalid = false;
                            document.getElementById('passwordConfirm').invalid = false;
                        }
                        if (document.getElementById('email').validate() &&
                            this.infos.username !== '' &&
                            this.infos.email !== '' &&
                            this.infos.password !== '' &&
                            this.infos.password === this.passwordConfirm) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                    else {
                        return true
                    }
                }
            });
        })();
    </script>
</dom-module>
