
<link rel="import" href="sa-mission-infos.html" />
<link rel="import" href="sa-missions-list.html" />
<link rel="import" href="../sa-kinds/sa-kinds-list.html" />
<link rel="import" href="../sa-toolbar/sa-secondary-toolbar-main.html" />
<link rel="import" href="../sa-toolbar/sa-secondary-toolbar-second.html" />
<link rel="import" href="../sa-toolbar/sa-toolbar-filter.html" />

<dom-module id="sa-missions">
    <style>
        :host {
            height: 100%;
            --paper-input-container-label : {                    
                    color: #cccccc;
            }
            --paper-input-container-input-color: #cccccc;
            --paper-input-container-underline-focus: {
                background: rgba(20, 20, 20, 0.97);
            }
            --paper-menu-button-dropdown-background:rgba(0, 0, 0, 0.67);
            --paper-dropdown-menu-input:{
                rgba(0, 0, 0, 0.67);
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
        }
    </style>
    <template>
        <div class="container">
            <iron-pages id="toolbar" selected="0">
                <sa-secondary-toolbar-main filter="{{_mainFilter}}"></sa-secondary-toolbar-main>
                <sa-secondary-toolbar-second id="tabs" kind="[[_selectedKind]]" on-back-to-previous-page="_backToPreviousPage" create-mission="[[createMission]]"></sa-secondary-toolbar-second>
            </iron-pages>
            <iron-collapse id="filter-toolbar">
                <sa-toolbar-filter on-sort-changed="_onSortedChanged"
                                   kind="[[_selectedKind]]"
                                   on-filter-add="_onFilterAdd"
                                   on-filter-remove="_onFilterRemove"></sa-toolbar-filter>
            </iron-collapse>
            <iron-pages id="pages" attr-for-selected="data-page" selected="missions">                

                <section data-page="missions">
                    <sa-missions-list filter="[[_missionsFilter]]" sort="[[_missionsSort]]" on-show-mission="_onShowMission" on-edit-mission="_onEditMission"></sa-missions-list>
                </section>
                <section data-page="kinds">
                    <sa-kinds-list on-show-missions="_onShowMissionsOfKind" on-get-kinds="_onGetKinds"></sa-kinds-list>
                </section>
                <section data-page="infos" id="infos-section">
                    <sa-mission-infos id="infos"
                                      kind="{{_selectedKind}}"
                                      kinds="[[_kinds]]"
                                      action="[[_infosAction]]"
                                      on-close-infos="_onCloseInfos"></sa-mission-infos>
                </section>
            </iron-pages>
        </div>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'sa-missions',

                properties: {
                    _kinds: Object,
                    _mainFilter: {
                        type: String,
                        observer: '_mainFilterChange'
                    },
                    _missionsFilter: Object,
                    createMission: {
                        type: Boolean,
                        notify: true,
                        observer: '_onBeginCreation'
                    },
                    _fromPages: {
                        type: Array,
                        value:[]
                    },
                    _infosAction: String,
                    clear:{
                        type: Boolean,
                        observer:'_onClear'
                    },
                },
                ready:function(){
                    this.$$('#filter-toolbar').show();
                },
                _onClear:function(e){
                    if (this.clear) {
                        this._fromPages = [];
                        this._mainFilter = 'missions';
                    }
                },
                _onBeginCreation: function (e) {
                    if(this.createMission){
                        this._showPage('creation');
                    }
                },
                _onGetKinds: function(e){
                    this.set('_kinds', e.detail.kinds);
                },
                _onShowMission:function(e){
                    this.$.infos.mission = e.detail.mission;
                    //this.$.tabs.addMissionTab(e.detail.mission);
                    this._showPage('consultation');
                },
                _onRequestLogin: function (event) {
                    this.fire('request-login', {});
                    this.$.pages.selected = 0;
                },
                _onShowMissionsOfKind: function (e) {
                    this._selectedKind = e.detail.kind;
                    this._missionsfilterAdd('kind');
                    this._showPage('missions');
                    this.$.toolbar.selected = 1;
                },
                _onSortedChanged:function(e){
                    this._missionsSort = {
                        type: e.detail.type
                    }
                },
                _onFilterAdd: function (e) {
                    this._missionsfilterAdd(e.detail.type);
                },
                _missionsfilterAdd:function(type){
                    if (!this._missionsFilter) {
                        this._missionsFilter = {
                            types: [type],
                            kind: this._selectedKind
                        }
                    }
                    else {
                        var filter = this._missionsFilter;
                        this._missionsFilter = null;
                        filter.types.push(type);
                        filter.kind = this._selectedKind;
                        this.set('_missionsFilter', filter);
                    }
                },
                _onCloseInfos:function(e){
                    this._showPage(this._fromPages[this._fromPages.length - 1]);
                },
                _onFilterRemove: function (e) {
                    this._missionsfilterRemove(e.detail.type);
                },
                _missionsfilterRemove: function (type) {
                    var filter = this._missionsFilter;
                    this._missionsFilter = null;
                    if (filter) {
                        for (var idx = 0; idx < filter.types.length; ++idx) {
                            if (filter.types[idx] == type) {
                                filter.types.splice(idx, 1);
                                break;
                            }
                        }
                        filter.kind = this._selectedKind;
                    }
                    this.set('_missionsFilter', filter);
                },
                _backToPreviousPage: function (e) {
                    var page = this._fromPages.pop();

                    if (this.$.pages.selected === 'infos' && page == 'missions') {
                        var backpage = this._fromPages[this._fromPages.length - 1];

                        if (backpage == 'kinds' && this._mainFilter == 'missions' || backpage == 'missions') {
                            this.$.toolbar.select(0);
                        }
                        else if(backpage == 'kinds')
                            this.$.toolbar.select(1);
                    }

                    this.createMission = false;
                    this._showPage(page);
                },
                _showPage: function (page) {
                    if (this.$.pages.selected != 'infos') {
                        if (this._fromPages.length > 10) {
                            this._fromPages.splice(0, 1);
                        }
                        this._fromPages.push(this.$.pages.selected);
                    }

                    this._infosAction = page;

                    switch (page) {
                        case 'kinds':
                            this.$.toolbar.select(0);
                            this.$$('#filter-toolbar').hide();
                            break;
                        case 'missions':
                            this.$$('#filter-toolbar').show();
                            break;
                        case 'creation':
                        case 'edition':
                        case 'consultation':
                            this._infosAction = page;
                            this.$$('#filter-toolbar').hide();
                            this.$.toolbar.select(1);
                            page = 'infos';
                            break;
                    }

                    this.fire('show-page', { 'page': page });
                    this.$.pages.select(page);
                },
                _mainFilterChange: function (e) {
                    switch (this._mainFilter) {
                        case 'missions':
                            this._selectedKind = null;
                            this._missionsfilterRemove('kind');
                            this._missionsfilterAdd('agent');
                            this.$.toolbar.select(0);
                            this._showPage('missions');
                            break;
                        case 'kinds': this._showPage('kinds');
                            break;
                    }
                }
            });
        })();
    </script>
</dom-module>
