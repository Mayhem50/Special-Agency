
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html" />
<link rel="import" href="../sa-xhr/sa-xhr.html" />
<link rel="import" href="sa-chat-list-item.html" />

<dom-module id="sa-chats-list">
    <style>
        :host {
            width: 600px;
            border-radius: 7px;
            display: flex;
            flex-direction: column;
            height: 795px;
            justify-content: space-between;
            @apply(--sa-chats-list);
        }

        #header {
            height: 50px;
            display: flex;
            background-color: #3a3a3a;
            color: #7c7c7c;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            padding-right:5px;
        }

        #header-icon {
            width: 40px;
        }

        #header-agent{
            display:flex;
            justify-content:center;
            align-items:center;
            flex-grow:2;
        }

        #header-text {
            display:flex;
            justify-content:center;
            align-items:center;
            flex-grow: 15;
        }

        #header-date {
            display:flex;
            justify-content:center;
            align-items:center;
            flex-grow:3;
        }

        #content {
            flex-grow: 2;
            display: flex;
            flex-direction: column;
            background-color: rgba(48, 48, 48, 0.40);
        }

        #footer {
            height: 50px;
            background-color: #efefef;
            color: #7c7c7c;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
    </style>
    <template>
        <div id="header">
            <div id="header-icon">
                &nbsp;
            </div>
            <div id="header-agent">
                Names
            </div>
            <div id="header-text">
                Messages
            </div>
            <div id="header-date">
                Dates
            </div>
        </div>
        <div id="content">
            <template id="list" is="dom-repeat" items="[[_chats]]" filter="_filterChat" observers="unreads">
                <sa-chat-list-item chat="[[item]]" on-click="_getChat"></sa-chat-list-item>
            </template>
            <paper-spinner active="[[_isLoading]]"></paper-spinner>
        </div>
        <div id="footer">

        </div>

        <sa-xhr id="xhr"
                url="[[_xhrUrl]]"
                result="{{_chats}}"
                on-result="_receiveChats"
                is-loading="{{_isLoading}}"
                token></sa-xhr>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'sa-chats-list',

                properties: {
                    _chats: {
                        type: Array,
                        value: []
                    },
                    _currentPage: Number,
                    _xhrUrl: String,
                    params: Object,
                    mission: {
                        type: Object,
                        observer: '_needRender'
                    },
                    userRole: {
                        type: String,
                        observer:'_needRender',
                        value: 'agent'
                    }
                },
                ready: function () {
                    Array.prototype.indexOfObject = function (property, value) {
                        for (var i = 0, len = this.length; i < len; i++) {
                            if (this[i][property] === value) return i;
                        }
                        return -1;
                    };
                },
                attached: function () {
                    if (!app.user) { return; }

                    this._xhrUrl = '/chats/' + app.user._id;

                    app.addEventListener('socket-connected', function (e) {
                        app.socket.on('new-chat', function (data) {
                            if (this._chats.indexOfObject('_id', data._id) != -1) { return; }

                            this.push('_chats', data);
                            app.chats.push(data);
                        }.bind(this));

                        app.socket.on('new-message', function (data) {
                            var idx = this._chats.indexOfObject('_id', data._chat);
                            if (idx < 0) { return; }
                            this._chats[idx]._messages.push(data);
                            app.chats[idx]._messages.push(data);
                        }.bind(this));
                    }.bind(this));

                    this.$.xhr.request();
                },
                _showPage: function (page) {
                    return this._chats;
                },
                _receiveChats: function (e) {
                    app.chats = this._chats;
                },
                _filterChat: function (item) {
                    var ret = true;

                    if (this.mission) {
                        ret &= item._mission._id == this.mission._id;
                    }
                    if (app.role == 'agent') {
                        ret &= item._agent._id == app.user._id;
                    }
                    else if (app.role == 'sponsor') {
                        ret &= item._sponsor._id == app.user._id;
                    }

                    return ret;
                },
                _needRender: function (e) {
                    this.$.list.render();
                },
                _getChat: function (e) {
                    var idx = this._chats.indexOfObject('_id', e.model.item._id);

                    if (idx > -1) {
                        var chat = this._chats[idx];
                        chat.unreads = 0;
                        this._chats.splice(idx, 1);
                        this._chats.push(chat);
                        e.currentTarget.updateChat(chat);
                    }
                    this.fire('chat-selected', { chat: e.model.item });
                }
            });
        })();

    </script>
</dom-module>

